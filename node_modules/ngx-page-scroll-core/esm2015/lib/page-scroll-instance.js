/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/**
 * An Interface specifying the possible options to be passed into the newInstance() factory method
 * @record
 */
export function PageScrollOptions() { }
if (false) {
    /**
     * The document object of the current app
     * @type {?}
     */
    PageScrollOptions.prototype.document;
    /**
     * A specification of the DOM element to scroll to. Either a string referring to an
     * element using a valid css selector (`#target`, `.class`, `div.class`) or a HTMLElement
     * that is attached to the document's DOM tree.
     * @type {?}
     */
    PageScrollOptions.prototype.scrollTarget;
    /**
     * Array of HTMLElements or the body object that should be manipulated while performing
     * the scroll animation.
     * @type {?|undefined}
     */
    PageScrollOptions.prototype.scrollViews;
    /**
     * Maximum speed to be used for the scroll animation. Only taken
     * into account of no duration is provided
     * @type {?|undefined}
     */
    PageScrollOptions.prototype.speed;
    /**
     * A listener to be called whenever the scroll animation stops
     * @type {?|undefined}
     */
    PageScrollOptions.prototype.scrollFinishListener;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.namespace;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.verticalScrolling;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.duration;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.scrollOffset;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.advancedInlineOffsetCalculation;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.interruptEvents;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.interruptKeys;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.interruptible;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.scrollInView;
    /** @type {?|undefined} */
    PageScrollOptions.prototype.easingLogic;
}
/**
 * Represents a scrolling action
 */
export class PageScrollInstance {
    /**
     * Private constructor, requires the properties assumed to be the bare minimum.
     * Use the factory methods to create instances:
     *      {\@link PageScrollService#create}
     * @param {?} pageScrollOptions
     */
    constructor(pageScrollOptions) {
        /**
         * These properties will be set/manipulated if the scroll animation starts
         */
        /* The initial value of the scrollTop or scrollLeft position when the animation starts */
        this.startScrollPosition = 0;
        /* Whether an interrupt listener is attached to the body or not */
        this.interruptListenersAttached = false;
        /* References to the timer instance that is used to perform the scroll animation to be
           able to clear it on animation end*/
        this.timer = null;
        if (!pageScrollOptions.scrollViews || pageScrollOptions.scrollViews.length === 0) {
            pageScrollOptions.scrollViews = [
                pageScrollOptions.document.documentElement,
                pageScrollOptions.document.body,
                pageScrollOptions.document.body.parentNode,
            ];
            this.isInlineScrolling = false;
        }
        else {
            this.isInlineScrolling = true;
        }
        this.pageScrollOptions = pageScrollOptions;
    }
    /**
     * @private
     * @param {?} pageScrollOptions
     * @param {?} scrollTargetElement
     * @return {?}
     */
    static getScrollingTargetPosition(pageScrollOptions, scrollTargetElement) {
        /** @type {?} */
        const body = pageScrollOptions.document.body;
        /** @type {?} */
        const docEl = pageScrollOptions.document.documentElement;
        /** @type {?} */
        const windowPageYOffset = pageScrollOptions.document.defaultView &&
            pageScrollOptions.document.defaultView.pageYOffset || undefined;
        /** @type {?} */
        const windowPageXOffset = pageScrollOptions.document.defaultView &&
            pageScrollOptions.document.defaultView.pageXOffset || undefined;
        /** @type {?} */
        const scrollTop = windowPageYOffset || docEl.scrollTop || body.scrollTop;
        /** @type {?} */
        const scrollLeft = windowPageXOffset || docEl.scrollLeft || body.scrollLeft;
        /** @type {?} */
        const clientTop = docEl.clientTop || body.clientTop || 0;
        /** @type {?} */
        const clientLeft = docEl.clientLeft || body.clientLeft || 0;
        if (scrollTargetElement === undefined || scrollTargetElement === null) {
            // No element found, so return the current position to not cause any change in scroll position
            return { top: scrollTop, left: scrollLeft };
        }
        /** @type {?} */
        const box = scrollTargetElement.getBoundingClientRect();
        /** @type {?} */
        const top = box.top + scrollTop - clientTop;
        /** @type {?} */
        const left = box.left + scrollLeft - clientLeft;
        return { top: Math.round(top), left: Math.round(left) };
    }
    /**
     * @private
     * @param {?} pageScrollOptions
     * @param {?} scrollTargetElement
     * @return {?}
     */
    static getInlineScrollingTargetPosition(pageScrollOptions, scrollTargetElement) {
        /** @type {?} */
        const position = { top: scrollTargetElement.offsetTop, left: scrollTargetElement.offsetLeft };
        if (pageScrollOptions.advancedInlineOffsetCalculation && pageScrollOptions.scrollViews.length === 1) {
            /** @type {?} */
            const accumulatedParentsPos = { top: 0, left: 0 };
            // not named window to make sure we're not getting the global window variable by accident
            /** @type {?} */
            const theWindow = scrollTargetElement.ownerDocument.defaultView;
            /** @type {?} */
            let parentFound = false;
            // Start parent is the immediate parent
            /** @type {?} */
            let parent = scrollTargetElement.parentElement;
            // Iterate upwards all parents
            while (!parentFound && parent !== undefined && parent !== null) {
                if (theWindow.getComputedStyle(parent).getPropertyValue('position') === 'relative') {
                    accumulatedParentsPos.top += parent.offsetTop;
                    accumulatedParentsPos.left += parent.offsetLeft;
                }
                // Next iteration
                parent = parent.parentElement;
                parentFound = parent === pageScrollOptions.scrollViews[0];
            }
            if (parentFound) {
                // Only use the results if we found the parent, otherwise we accumulated too much anyway
                position.top += accumulatedParentsPos.top;
                position.left += accumulatedParentsPos.left;
            }
            else {
                /* TODO Uncomment
                if (PageScrollConfig._logLevel >= 2 || (PageScrollConfig._logLevel >= 1 && isDevMode())) {
                  console.warn('Unable to find nested scrolling targets parent!');
                }*/
            }
        }
        return position;
    }
    /**
     * @param {?} scrollingView
     * @return {?}
     */
    getScrollPropertyValue(scrollingView) {
        if (!this.pageScrollOptions.verticalScrolling) {
            return scrollingView.scrollLeft;
        }
        return scrollingView.scrollTop;
    }
    /**
     * @param {?} scrollingView
     * @return {?}
     */
    getScrollClientPropertyValue(scrollingView) {
        if (!this.pageScrollOptions.verticalScrolling) {
            return scrollingView.clientWidth;
        }
        return scrollingView.clientHeight;
    }
    /**
     * Extract the exact location of the scrollTarget element.
     *
     * Extract the scrollTarget HTMLElement from the given PageScrollTarget object. The latter one may be
     * a string like "#heading2", then this method returns the corresponding DOM element for that id.
     *
     * @return {?}
     */
    extractScrollTargetPosition() {
        /** @type {?} */
        const scrollTargetElement = this.getScrollTargetElement();
        if (scrollTargetElement === null || scrollTargetElement === undefined) {
            // Scroll target not found
            return { top: NaN, left: NaN };
        }
        if (this.isInlineScrolling) {
            return PageScrollInstance.getInlineScrollingTargetPosition(this.pageScrollOptions, scrollTargetElement);
        }
        return PageScrollInstance.getScrollingTargetPosition(this.pageScrollOptions, scrollTargetElement);
    }
    /**
     * Get the top offset of the scroll animation.
     * This automatically takes the offset location of the scrolling container/scrolling view
     * into account (for nested/inline scrolling).
     * @return {?}
     */
    getCurrentOffset() {
        return this.pageScrollOptions.scrollOffset;
    }
    /**
     * Sets the "scrollTop" or "scrollLeft" property for all scrollViews to the provided value
     * @param {?} position
     * @return {?} true if at least for one ScrollTopSource the scrollTop/scrollLeft value could be set and it kept the new value.
     *          false if it failed for all ScrollViews, meaning that we should stop the animation
     *          (probably because we're at the end of the scrolling region)
     */
    setScrollPosition(position) {
        // Set the new scrollTop/scrollLeft to all scrollViews elements
        return this.pageScrollOptions.scrollViews.reduce((/**
         * @param {?} oneAlreadyWorked
         * @param {?} scrollingView
         * @return {?}
         */
        (oneAlreadyWorked, scrollingView) => {
            /** @type {?} */
            const startScrollPropertyValue = this.getScrollPropertyValue(scrollingView);
            if (scrollingView && startScrollPropertyValue !== undefined && startScrollPropertyValue !== null) {
                /** @type {?} */
                const scrollDistance = Math.abs(startScrollPropertyValue - position);
                // The movement we need to perform is less than 2px
                // This we consider a small movement which some browser may not perform when
                // changing the scrollTop/scrollLeft property
                // Thus in this cases we do not stop the scroll animation, although setting the
                // scrollTop/scrollLeft value "fails"
                /** @type {?} */
                const isSmallMovement = scrollDistance < this.pageScrollOptions._minScrollDistance;
                if (!this.pageScrollOptions.verticalScrolling) {
                    scrollingView.scrollLeft = position;
                }
                else {
                    scrollingView.scrollTop = position;
                }
                // Return true if setting the new scrollTop/scrollLeft value worked
                // We consider that it worked if the new scrollTop/scrollLeft value is closer to the
                // desired scrollTop/scrollLeft than before (it might not be exactly the value we
                // set due to dpi or rounding irregularities)
                if (isSmallMovement || scrollDistance > Math.abs(this.getScrollPropertyValue(scrollingView) - position)) {
                    return true;
                }
            }
            return oneAlreadyWorked;
        }), false);
    }
    /**
     * Trigger firing a animation finish event
     * @param {?} value Whether the animation finished at the target (true) or got interrupted (false)
     * @return {?}
     */
    fireEvent(value) {
        if (this.pageScrollOptions.scrollFinishListener) {
            this.pageScrollOptions.scrollFinishListener.emit(value);
        }
    }
    /**
     * Attach the interrupt listeners to the PageScrollInstance body. The given interruptReporter
     * will be called if any of the attached events is fired.
     *
     * Possibly attached interruptListeners are automatically removed from the body before the new one will be attached.
     * @param {?} interruptReporter
     * @return {?}
     */
    attachInterruptListeners(interruptReporter) {
        if (this.interruptListenersAttached) {
            // Detach possibly existing listeners first
            this.detachInterruptListeners();
        }
        this.interruptListener = (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            interruptReporter.report(event, this);
        });
        this.pageScrollOptions.interruptEvents.forEach((/**
         * @param {?} event
         * @return {?}
         */
        (event) => this.pageScrollOptions.document.body.addEventListener(event, this.interruptListener)));
        this.interruptListenersAttached = true;
    }
    /**
     * Remove event listeners from the body and stop listening for events that might be treated as "animation
     * interrupt" events.
     * @return {?}
     */
    detachInterruptListeners() {
        this.pageScrollOptions.interruptEvents.forEach((/**
         * @param {?} event
         * @return {?}
         */
        (event) => this.pageScrollOptions.document.body.removeEventListener(event, this.interruptListener)));
        this.interruptListenersAttached = false;
    }
    /**
     * @private
     * @return {?}
     */
    getScrollTargetElement() {
        if (typeof this.pageScrollOptions.scrollTarget === 'string') {
            /** @type {?} */
            const targetSelector = (/** @type {?} */ (this.pageScrollOptions.scrollTarget));
            if (targetSelector.match(/^#[^\s]+$/g) !== null) {
                // It's an id selector and a valid id, as it does not contain any white space characters
                return this.pageScrollOptions.document.getElementById(targetSelector.substr(1));
            }
            return (/** @type {?} */ (this.pageScrollOptions.document.querySelector(targetSelector)));
        }
        return (/** @type {?} */ (this.pageScrollOptions.scrollTarget));
    }
}
if (false) {
    /** @type {?} */
    PageScrollInstance.prototype.pageScrollOptions;
    /**
     * @type {?}
     * @private
     */
    PageScrollInstance.prototype.isInlineScrolling;
    /**
     * @type {?}
     * @private
     */
    PageScrollInstance.prototype.interruptListener;
    /**
     * These properties will be set/manipulated if the scroll animation starts
     * @type {?}
     */
    PageScrollInstance.prototype.startScrollPosition;
    /** @type {?} */
    PageScrollInstance.prototype.targetScrollPosition;
    /** @type {?} */
    PageScrollInstance.prototype.distanceToScroll;
    /** @type {?} */
    PageScrollInstance.prototype.startTime;
    /** @type {?} */
    PageScrollInstance.prototype.endTime;
    /** @type {?} */
    PageScrollInstance.prototype.executionDuration;
    /** @type {?} */
    PageScrollInstance.prototype.interruptListenersAttached;
    /** @type {?} */
    PageScrollInstance.prototype.timer;
}
/**
 * An Interface a listener should implement to be notified about possible interrupt events
 * that happened due to user interaction while a scroll animation takes place.
 *
 * The PageScrollService provides an implementation to a PageScrollInstance to be notified
 * about scroll animation interrupts and stop related animations.
 * @record
 */
export function InterruptReporter() { }
if (false) {
    /**
     * @param {?} event
     * @param {?} pageScrollInstance
     * @return {?}
     */
    InterruptReporter.prototype.report = function (event, pageScrollInstance) { };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1zY3JvbGwtaW5zdGFuY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtcGFnZS1zY3JvbGwtY29yZS8iLCJzb3VyY2VzIjpbImxpYi9wYWdlLXNjcm9sbC1pbnN0YW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQVNBLHVDQXdDQzs7Ozs7O0lBcENDLHFDQUFtQjs7Ozs7OztJQU9uQix5Q0FBK0I7Ozs7OztJQU0vQix3Q0FBZ0M7Ozs7OztJQU1oQyxrQ0FBZTs7Ozs7SUFLZixpREFBNkM7O0lBRTdDLHNDQUFtQjs7SUFDbkIsOENBQTRCOztJQUM1QixxQ0FBa0I7O0lBQ2xCLHlDQUFzQjs7SUFDdEIsNERBQTBDOztJQUMxQyw0Q0FBMkI7O0lBQzNCLDBDQUF5Qjs7SUFDekIsMENBQXdCOztJQUN4Qix5Q0FBdUI7O0lBQ3ZCLHdDQUEwQjs7Ozs7QUFNNUIsTUFBTSxPQUFPLGtCQUFrQjs7Ozs7OztJQXFDN0IsWUFBWSxpQkFBb0M7Ozs7O1FBdkJ6Qyx3QkFBbUIsR0FBRyxDQUFDLENBQUM7O1FBWXhCLCtCQUEwQixHQUFHLEtBQUssQ0FBQzs7O1FBSW5DLFVBQUssR0FBUSxJQUFJLENBQUM7UUFRdkIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsSUFBSSxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNoRixpQkFBaUIsQ0FBQyxXQUFXLEdBQUc7Z0JBQzlCLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxlQUFlO2dCQUMxQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsSUFBSTtnQkFDL0IsaUJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVO2FBQzNDLENBQUM7WUFDRixJQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDO1NBQ2hDO2FBQU07WUFDTCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDO1NBQy9CO1FBRUQsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixD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QVksRUFBQTtZQUNsRSxJQUFJLGNBQWMsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLEtBQUssSUFBSSxFQUFFO2dCQUMvQyx3RkFBd0Y7Z0JBRXhGLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2pGO1lBRUQsT0FBTyxtQkFBYSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsRUFBQSxDQUFDO1NBQ25GO1FBRUQsT0FBTyxtQkFBYSxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxFQUFBLENBQUM7SUFDMUQsQ0FBQztDQUNGOzs7SUFoUUMsK0NBQTRDOzs7OztJQUU1QywrQ0FBbUM7Ozs7O0lBSW5DLCtDQUE4RDs7Ozs7SUFNOUQsaURBQStCOztJQUUvQixrREFBb0M7O0lBRXBDLDhDQUFnQzs7SUFFaEMsdUNBQXlCOztJQUV6QixxQ0FBdUI7O0lBRXZCLCtDQUFpQzs7SUFFakMsd0RBQTBDOztJQUkxQyxtQ0FBeUI7Ozs7Ozs7Ozs7QUE2TzNCLHVDQUVDOzs7Ozs7O0lBREMsOEVBQW1FIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQYWdlU2Nyb2xsQ29uZmlnIH0gZnJvbSAnLi90eXBlcy9wYWdlLXNjcm9sbC5jb25maWcnO1xuaW1wb3J0IHsgUGFnZVNjcm9sbFRhcmdldCB9IGZyb20gJy4vdHlwZXMvcGFnZS1zY3JvbGwtdGFyZ2V0JztcbmltcG9ydCB7IFBhZ2VTY3JvbGxWaWV3cyB9IGZyb20gJy4vdHlwZXMvcGFnZS1zY3JvbGwtdmlldyc7XG5pbXBvcnQgeyBFYXNpbmdMb2dpYyB9IGZyb20gJy4vdHlwZXMvZWFzaW5nLWxvZ2ljJztcblxuLyoqXG4gKiBBbiBJbnRlcmZhY2Ugc3BlY2lmeWluZyB0aGUgcG9zc2libGUgb3B0aW9ucyB0byBiZSBwYXNzZWQgaW50byB0aGUgbmV3SW5zdGFuY2UoKSBmYWN0b3J5IG1ldGhvZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFBhZ2VTY3JvbGxPcHRpb25zIGV4dGVuZHMgUGFnZVNjcm9sbENvbmZpZyB7XG4gIC8qKlxuICAgKiBUaGUgZG9jdW1lbnQgb2JqZWN0IG9mIHRoZSBjdXJyZW50IGFwcFxuICAgKi9cbiAgZG9jdW1lbnQ6IERvY3VtZW50O1xuXG4gIC8qKlxuICAgKiBBIHNwZWNpZmljYXRpb24gb2YgdGhlIERPTSBlbGVtZW50IHRvIHNjcm9sbCB0by4gRWl0aGVyIGEgc3RyaW5nIHJlZmVycmluZyB0byBhblxuICAgKiBlbGVtZW50IHVzaW5nIGEgdmFsaWQgY3NzIHNlbGVjdG9yIChgI3RhcmdldGAsIGAuY2xhc3NgLCBgZGl2LmNsYXNzYCkgb3IgYSBIVE1MRWxlbWVudFxuICAgKiB0aGF0IGlzIGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudCdzIERPTSB0cmVlLlxuICAgKi9cbiAgc2Nyb2xsVGFyZ2V0OiBQYWdlU2Nyb2xsVGFyZ2V0O1xuXG4gIC8qKlxuICAgKiBBcnJheSBvZiBIVE1MRWxlbWVudHMgb3IgdGhlIGJvZHkgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIG1hbmlwdWxhdGVkIHdoaWxlIHBlcmZvcm1pbmdcbiAgICogdGhlIHNjcm9sbCBhbmltYXRpb24uXG4gICAqL1xuICBzY3JvbGxWaWV3cz86IFBhZ2VTY3JvbGxWaWV3c1tdO1xuXG4gIC8qKlxuICAgKiBNYXhpbXVtIHNwZWVkIHRvIGJlIHVzZWQgZm9yIHRoZSBzY3JvbGwgYW5pbWF0aW9uLiBPbmx5IHRha2VuXG4gICAqIGludG8gYWNjb3VudCBvZiBubyBkdXJhdGlvbiBpcyBwcm92aWRlZFxuICAgKi9cbiAgc3BlZWQ/OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIEEgbGlzdGVuZXIgdG8gYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBzY3JvbGwgYW5pbWF0aW9uIHN0b3BzXG4gICAqL1xuICBzY3JvbGxGaW5pc2hMaXN0ZW5lcj86IEV2ZW50RW1pdHRlcjxib29sZWFuPjtcblxuICBuYW1lc3BhY2U/OiBzdHJpbmc7XG4gIHZlcnRpY2FsU2Nyb2xsaW5nPzogYm9vbGVhbjtcbiAgZHVyYXRpb24/OiBudW1iZXI7XG4gIHNjcm9sbE9mZnNldD86IG51bWJlcjtcbiAgYWR2YW5jZWRJbmxpbmVPZmZzZXRDYWxjdWxhdGlvbj86IGJvb2xlYW47XG4gIGludGVycnVwdEV2ZW50cz86IHN0cmluZ1tdO1xuICBpbnRlcnJ1cHRLZXlzPzogc3RyaW5nW107XG4gIGludGVycnVwdGlibGU/OiBib29sZWFuO1xuICBzY3JvbGxJblZpZXc/OiBib29sZWFuO1xuICBlYXNpbmdMb2dpYz86IEVhc2luZ0xvZ2ljO1xufVxuXG4vKipcbiAqIFJlcHJlc2VudHMgYSBzY3JvbGxpbmcgYWN0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBQYWdlU2Nyb2xsSW5zdGFuY2Uge1xuXG4gIHB1YmxpYyBwYWdlU2Nyb2xsT3B0aW9uczogUGFnZVNjcm9sbE9wdGlvbnM7XG5cbiAgcHJpdmF0ZSBpc0lubGluZVNjcm9sbGluZzogYm9vbGVhbjtcblxuICAvKiBUaGUgbGlzdGVuZXIgdGhhdCB0aGlzIHNjcm9sbCBpbnN0YW5jZSBhdHRhY2hlcyB0byB0aGUgYm9keSB0byBsaXN0ZW4gZm9yIGludGVycnVwdCBldmVudHNcbiAgV2UncmUga2VlcGluZyBhIHJlZmVyZW5jZSB0byBpdCBzbyB3ZSBjYW4gcHJvcGVybHkgcmVtb3ZlIGl0IHdoZW4gdGhlIGFuaW1hdGlvbiBmaW5pc2hlcyAqL1xuICBwcml2YXRlIGludGVycnVwdExpc3RlbmVyOiBFdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0O1xuXG4gIC8qKlxuICAgKiBUaGVzZSBwcm9wZXJ0aWVzIHdpbGwgYmUgc2V0L21hbmlwdWxhdGVkIGlmIHRoZSBzY3JvbGwgYW5pbWF0aW9uIHN0YXJ0c1xuICAgKi9cbiAgLyogVGhlIGluaXRpYWwgdmFsdWUgb2YgdGhlIHNjcm9sbFRvcCBvciBzY3JvbGxMZWZ0IHBvc2l0aW9uIHdoZW4gdGhlIGFuaW1hdGlvbiBzdGFydHMgKi9cbiAgcHVibGljIHN0YXJ0U2Nyb2xsUG9zaXRpb24gPSAwO1xuICAvKiBUaGUgdGFyZ2V0IHZhbHVlIG9mIHRoZSBzY3JvbGxUb3Agb3Igc2Nyb2xsTGVmdCBwb3NpdGlvbiBmb3IgdGhlIGFuaW1hdGlvbiAoYWthIFwidGhlIGZpbmFsIGRlc3RpbmF0aW9uXCIpICovXG4gIHB1YmxpYyB0YXJnZXRTY3JvbGxQb3NpdGlvbjogbnVtYmVyO1xuICAvKiBEaWZmZXJlbmNlIGJldHdlZW4gc3RhcnRTY3JvbGxQb3NpdGlvbiBhbmQgdGFyZ2V0U2Nyb2xsUG9zaXRpb24uIFByZS1jYWxjdWxhdGVkIHRvIG1pbmltaXplIGNvbXB1dGF0aW9ucyBkdXJpbmcgYW5pbWF0aW9uICovXG4gIHB1YmxpYyBkaXN0YW5jZVRvU2Nyb2xsOiBudW1iZXI7XG4gIC8qIFRoZSB0aW1lc3RhbXAgd2hlbiB0aGUgYW5pbWF0aW9uIHN0YXJ0cy9nb3Qgc3RhcnRlZCAqL1xuICBwdWJsaWMgc3RhcnRUaW1lOiBudW1iZXI7XG4gIC8qIFRoZSBlc3RpbWF0ZSBlbmQgdGltZSBvZiB0aGUgYW5pbWF0aW9uLCBjYWxjdWxhdGVkIGJ5IHN0YXJ0VGltZSArIGR1cmF0aW9uICovXG4gIHB1YmxpYyBlbmRUaW1lOiBudW1iZXI7XG4gIC8qIFRoZSBkdXJhdGlvbiBhIHN0YXJ0ZWQgYW5pbWF0aW9uIHRha2VzLiBUaGlzIG1heSBtYXRjaCB0aGUgX2R1cmF0aW9uIG9yIGJlIGFkanVzdGVkIGR1ZSB0byB0aGUgX3NwZWVkIG9wdGlvbiAqL1xuICBwdWJsaWMgZXhlY3V0aW9uRHVyYXRpb246IG51bWJlcjtcbiAgLyogV2hldGhlciBhbiBpbnRlcnJ1cHQgbGlzdGVuZXIgaXMgYXR0YWNoZWQgdG8gdGhlIGJvZHkgb3Igbm90ICovXG4gIHB1YmxpYyBpbnRlcnJ1cHRMaXN0ZW5lcnNBdHRhY2hlZCA9IGZhbHNlO1xuXG4gIC8qIFJlZmVyZW5jZXMgdG8gdGhlIHRpbWVyIGluc3RhbmNlIHRoYXQgaXMgdXNlZCB0byBwZXJmb3JtIHRoZSBzY3JvbGwgYW5pbWF0aW9uIHRvIGJlXG4gICBhYmxlIHRvIGNsZWFyIGl0IG9uIGFuaW1hdGlvbiBlbmQqL1xuICBwdWJsaWMgdGltZXI6IGFueSA9IG51bGw7XG5cbiAgLyoqXG4gICAqIFByaXZhdGUgY29uc3RydWN0b3IsIHJlcXVpcmVzIHRoZSBwcm9wZXJ0aWVzIGFzc3VtZWQgdG8gYmUgdGhlIGJhcmUgbWluaW11bS5cbiAgICogVXNlIHRoZSBmYWN0b3J5IG1ldGhvZHMgdG8gY3JlYXRlIGluc3RhbmNlczpcbiAgICogICAgICB7QGxpbmsgUGFnZVNjcm9sbFNlcnZpY2UjY3JlYXRlfVxuICAgKi9cbiAgY29uc3RydWN0b3IocGFnZVNjcm9sbE9wdGlvbnM6IFBhZ2VTY3JvbGxPcHRpb25zKSB7XG4gICAgaWYgKCFwYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3cyB8fCBwYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbFZpZXdzID0gW1xuICAgICAgICBwYWdlU2Nyb2xsT3B0aW9ucy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsXG4gICAgICAgIHBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LmJvZHksXG4gICAgICAgIHBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LmJvZHkucGFyZW50Tm9kZSxcbiAgICAgIF07XG4gICAgICB0aGlzLmlzSW5saW5lU2Nyb2xsaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaXNJbmxpbmVTY3JvbGxpbmcgPSB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMucGFnZVNjcm9sbE9wdGlvbnMgPSBwYWdlU2Nyb2xsT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGdldFNjcm9sbGluZ1RhcmdldFBvc2l0aW9uKHBhZ2VTY3JvbGxPcHRpb25zOiBQYWdlU2Nyb2xsT3B0aW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVGFyZ2V0RWxlbWVudDogSFRNTEVsZW1lbnQpOiB7IHRvcDogbnVtYmVyLCBsZWZ0OiBudW1iZXIgfSB7XG4gICAgY29uc3QgYm9keSA9IHBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LmJvZHk7XG4gICAgY29uc3QgZG9jRWwgPSBwYWdlU2Nyb2xsT3B0aW9ucy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG5cbiAgICBjb25zdCB3aW5kb3dQYWdlWU9mZnNldDogbnVtYmVyID0gcGFnZVNjcm9sbE9wdGlvbnMuZG9jdW1lbnQuZGVmYXVsdFZpZXcgJiZcbiAgICAgIHBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LmRlZmF1bHRWaWV3LnBhZ2VZT2Zmc2V0IHx8IHVuZGVmaW5lZDtcbiAgICBjb25zdCB3aW5kb3dQYWdlWE9mZnNldDogbnVtYmVyID0gcGFnZVNjcm9sbE9wdGlvbnMuZG9jdW1lbnQuZGVmYXVsdFZpZXcgJiZcbiAgICAgIHBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LmRlZmF1bHRWaWV3LnBhZ2VYT2Zmc2V0IHx8IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0IHNjcm9sbFRvcCA9IHdpbmRvd1BhZ2VZT2Zmc2V0IHx8IGRvY0VsLnNjcm9sbFRvcCB8fCBib2R5LnNjcm9sbFRvcDtcbiAgICBjb25zdCBzY3JvbGxMZWZ0ID0gd2luZG93UGFnZVhPZmZzZXQgfHwgZG9jRWwuc2Nyb2xsTGVmdCB8fCBib2R5LnNjcm9sbExlZnQ7XG5cbiAgICBjb25zdCBjbGllbnRUb3AgPSBkb2NFbC5jbGllbnRUb3AgfHwgYm9keS5jbGllbnRUb3AgfHwgMDtcbiAgICBjb25zdCBjbGllbnRMZWZ0ID0gZG9jRWwuY2xpZW50TGVmdCB8fCBib2R5LmNsaWVudExlZnQgfHwgMDtcblxuICAgIGlmIChzY3JvbGxUYXJnZXRFbGVtZW50ID09PSB1bmRlZmluZWQgfHwgc2Nyb2xsVGFyZ2V0RWxlbWVudCA9PT0gbnVsbCkge1xuICAgICAgLy8gTm8gZWxlbWVudCBmb3VuZCwgc28gcmV0dXJuIHRoZSBjdXJyZW50IHBvc2l0aW9uIHRvIG5vdCBjYXVzZSBhbnkgY2hhbmdlIGluIHNjcm9sbCBwb3NpdGlvblxuICAgICAgcmV0dXJuIHt0b3A6IHNjcm9sbFRvcCwgbGVmdDogc2Nyb2xsTGVmdH07XG4gICAgfVxuICAgIGNvbnN0IGJveCA9IHNjcm9sbFRhcmdldEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICBjb25zdCB0b3AgPSBib3gudG9wICsgc2Nyb2xsVG9wIC0gY2xpZW50VG9wO1xuICAgIGNvbnN0IGxlZnQgPSBib3gubGVmdCArIHNjcm9sbExlZnQgLSBjbGllbnRMZWZ0O1xuXG4gICAgcmV0dXJuIHt0b3A6IE1hdGgucm91bmQodG9wKSwgbGVmdDogTWF0aC5yb3VuZChsZWZ0KX07XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBnZXRJbmxpbmVTY3JvbGxpbmdUYXJnZXRQb3NpdGlvbihwYWdlU2Nyb2xsT3B0aW9uczogUGFnZVNjcm9sbE9wdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRhcmdldEVsZW1lbnQ6IEhUTUxFbGVtZW50KTogeyB0b3A6IG51bWJlciwgbGVmdDogbnVtYmVyIH0ge1xuICAgIGNvbnN0IHBvc2l0aW9uID0ge3RvcDogc2Nyb2xsVGFyZ2V0RWxlbWVudC5vZmZzZXRUb3AsIGxlZnQ6IHNjcm9sbFRhcmdldEVsZW1lbnQub2Zmc2V0TGVmdH07XG4gICAgaWYgKHBhZ2VTY3JvbGxPcHRpb25zLmFkdmFuY2VkSW5saW5lT2Zmc2V0Q2FsY3VsYXRpb24gJiYgcGFnZVNjcm9sbE9wdGlvbnMuc2Nyb2xsVmlld3MubGVuZ3RoID09PSAxKSB7XG4gICAgICBjb25zdCBhY2N1bXVsYXRlZFBhcmVudHNQb3MgPSB7dG9wOiAwLCBsZWZ0OiAwfTtcbiAgICAgIC8vIG5vdCBuYW1lZCB3aW5kb3cgdG8gbWFrZSBzdXJlIHdlJ3JlIG5vdCBnZXR0aW5nIHRoZSBnbG9iYWwgd2luZG93IHZhcmlhYmxlIGJ5IGFjY2lkZW50XG4gICAgICBjb25zdCB0aGVXaW5kb3cgPSBzY3JvbGxUYXJnZXRFbGVtZW50Lm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7XG4gICAgICBsZXQgcGFyZW50Rm91bmQgPSBmYWxzZTtcblxuICAgICAgLy8gU3RhcnQgcGFyZW50IGlzIHRoZSBpbW1lZGlhdGUgcGFyZW50XG4gICAgICBsZXQgcGFyZW50ID0gc2Nyb2xsVGFyZ2V0RWxlbWVudC5wYXJlbnRFbGVtZW50O1xuXG4gICAgICAvLyBJdGVyYXRlIHVwd2FyZHMgYWxsIHBhcmVudHNcbiAgICAgIHdoaWxlICghcGFyZW50Rm91bmQgJiYgcGFyZW50ICE9PSB1bmRlZmluZWQgJiYgcGFyZW50ICE9PSBudWxsKSB7XG4gICAgICAgIGlmICh0aGVXaW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShwYXJlbnQpLmdldFByb3BlcnR5VmFsdWUoJ3Bvc2l0aW9uJykgPT09ICdyZWxhdGl2ZScpIHtcbiAgICAgICAgICBhY2N1bXVsYXRlZFBhcmVudHNQb3MudG9wICs9IHBhcmVudC5vZmZzZXRUb3A7XG4gICAgICAgICAgYWNjdW11bGF0ZWRQYXJlbnRzUG9zLmxlZnQgKz0gcGFyZW50Lm9mZnNldExlZnQ7XG4gICAgICAgIH1cbiAgICAgICAgLy8gTmV4dCBpdGVyYXRpb25cbiAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgICAgIHBhcmVudEZvdW5kID0gcGFyZW50ID09PSBwYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3c1swXTtcbiAgICAgIH1cbiAgICAgIGlmIChwYXJlbnRGb3VuZCkge1xuICAgICAgICAvLyBPbmx5IHVzZSB0aGUgcmVzdWx0cyBpZiB3ZSBmb3VuZCB0aGUgcGFyZW50LCBvdGhlcndpc2Ugd2UgYWNjdW11bGF0ZWQgdG9vIG11Y2ggYW55d2F5XG4gICAgICAgIHBvc2l0aW9uLnRvcCArPSBhY2N1bXVsYXRlZFBhcmVudHNQb3MudG9wO1xuICAgICAgICBwb3NpdGlvbi5sZWZ0ICs9IGFjY3VtdWxhdGVkUGFyZW50c1Bvcy5sZWZ0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLyogVE9ETyBVbmNvbW1lbnRcbiAgICAgICAgaWYgKFBhZ2VTY3JvbGxDb25maWcuX2xvZ0xldmVsID49IDIgfHwgKFBhZ2VTY3JvbGxDb25maWcuX2xvZ0xldmVsID49IDEgJiYgaXNEZXZNb2RlKCkpKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKCdVbmFibGUgdG8gZmluZCBuZXN0ZWQgc2Nyb2xsaW5nIHRhcmdldHMgcGFyZW50IScpO1xuICAgICAgICB9Ki9cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcG9zaXRpb247XG4gIH1cblxuICBwdWJsaWMgZ2V0U2Nyb2xsUHJvcGVydHlWYWx1ZShzY3JvbGxpbmdWaWV3OiBhbnkpOiBudW1iZXIge1xuICAgIGlmICghdGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy52ZXJ0aWNhbFNjcm9sbGluZykge1xuICAgICAgcmV0dXJuIHNjcm9sbGluZ1ZpZXcuc2Nyb2xsTGVmdDtcbiAgICB9XG5cbiAgICByZXR1cm4gc2Nyb2xsaW5nVmlldy5zY3JvbGxUb3A7XG4gIH1cblxuICBwdWJsaWMgZ2V0U2Nyb2xsQ2xpZW50UHJvcGVydHlWYWx1ZShzY3JvbGxpbmdWaWV3OiBhbnkpOiBudW1iZXIge1xuICAgIGlmICghdGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy52ZXJ0aWNhbFNjcm9sbGluZykge1xuICAgICAgcmV0dXJuIHNjcm9sbGluZ1ZpZXcuY2xpZW50V2lkdGg7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNjcm9sbGluZ1ZpZXcuY2xpZW50SGVpZ2h0O1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgdGhlIGV4YWN0IGxvY2F0aW9uIG9mIHRoZSBzY3JvbGxUYXJnZXQgZWxlbWVudC5cbiAgICpcbiAgICogRXh0cmFjdCB0aGUgc2Nyb2xsVGFyZ2V0IEhUTUxFbGVtZW50IGZyb20gdGhlIGdpdmVuIFBhZ2VTY3JvbGxUYXJnZXQgb2JqZWN0LiBUaGUgbGF0dGVyIG9uZSBtYXkgYmVcbiAgICogYSBzdHJpbmcgbGlrZSBcIiNoZWFkaW5nMlwiLCB0aGVuIHRoaXMgbWV0aG9kIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgRE9NIGVsZW1lbnQgZm9yIHRoYXQgaWQuXG4gICAqXG4gICAqL1xuICBwdWJsaWMgZXh0cmFjdFNjcm9sbFRhcmdldFBvc2l0aW9uKCk6IHsgdG9wOiBudW1iZXIsIGxlZnQ6IG51bWJlciB9IHtcbiAgICBjb25zdCBzY3JvbGxUYXJnZXRFbGVtZW50ID0gdGhpcy5nZXRTY3JvbGxUYXJnZXRFbGVtZW50KCk7XG5cbiAgICBpZiAoc2Nyb2xsVGFyZ2V0RWxlbWVudCA9PT0gbnVsbCB8fCBzY3JvbGxUYXJnZXRFbGVtZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIFNjcm9sbCB0YXJnZXQgbm90IGZvdW5kXG4gICAgICByZXR1cm4ge3RvcDogTmFOLCBsZWZ0OiBOYU59O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzSW5saW5lU2Nyb2xsaW5nKSB7XG4gICAgICByZXR1cm4gUGFnZVNjcm9sbEluc3RhbmNlLmdldElubGluZVNjcm9sbGluZ1RhcmdldFBvc2l0aW9uKHRoaXMucGFnZVNjcm9sbE9wdGlvbnMsIHNjcm9sbFRhcmdldEVsZW1lbnQpO1xuICAgIH1cblxuICAgIHJldHVybiBQYWdlU2Nyb2xsSW5zdGFuY2UuZ2V0U2Nyb2xsaW5nVGFyZ2V0UG9zaXRpb24odGhpcy5wYWdlU2Nyb2xsT3B0aW9ucywgc2Nyb2xsVGFyZ2V0RWxlbWVudCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSB0b3Agb2Zmc2V0IG9mIHRoZSBzY3JvbGwgYW5pbWF0aW9uLlxuICAgKiBUaGlzIGF1dG9tYXRpY2FsbHkgdGFrZXMgdGhlIG9mZnNldCBsb2NhdGlvbiBvZiB0aGUgc2Nyb2xsaW5nIGNvbnRhaW5lci9zY3JvbGxpbmcgdmlld1xuICAgKiBpbnRvIGFjY291bnQgKGZvciBuZXN0ZWQvaW5saW5lIHNjcm9sbGluZykuXG4gICAqL1xuICBwdWJsaWMgZ2V0Q3VycmVudE9mZnNldCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbE9mZnNldDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBcInNjcm9sbFRvcFwiIG9yIFwic2Nyb2xsTGVmdFwiIHByb3BlcnR5IGZvciBhbGwgc2Nyb2xsVmlld3MgdG8gdGhlIHByb3ZpZGVkIHZhbHVlXG4gICAqIEByZXR1cm4gdHJ1ZSBpZiBhdCBsZWFzdCBmb3Igb25lIFNjcm9sbFRvcFNvdXJjZSB0aGUgc2Nyb2xsVG9wL3Njcm9sbExlZnQgdmFsdWUgY291bGQgYmUgc2V0IGFuZCBpdCBrZXB0IHRoZSBuZXcgdmFsdWUuXG4gICAqICAgICAgICAgIGZhbHNlIGlmIGl0IGZhaWxlZCBmb3IgYWxsIFNjcm9sbFZpZXdzLCBtZWFuaW5nIHRoYXQgd2Ugc2hvdWxkIHN0b3AgdGhlIGFuaW1hdGlvblxuICAgKiAgICAgICAgICAocHJvYmFibHkgYmVjYXVzZSB3ZSdyZSBhdCB0aGUgZW5kIG9mIHRoZSBzY3JvbGxpbmcgcmVnaW9uKVxuICAgKi9cbiAgcHVibGljIHNldFNjcm9sbFBvc2l0aW9uKHBvc2l0aW9uOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAvLyBTZXQgdGhlIG5ldyBzY3JvbGxUb3Avc2Nyb2xsTGVmdCB0byBhbGwgc2Nyb2xsVmlld3MgZWxlbWVudHNcbiAgICByZXR1cm4gdGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3cy5yZWR1Y2UoKG9uZUFscmVhZHlXb3JrZWQ6IGFueSwgc2Nyb2xsaW5nVmlldzogYW55KSA9PiB7XG4gICAgICBjb25zdCBzdGFydFNjcm9sbFByb3BlcnR5VmFsdWUgPSB0aGlzLmdldFNjcm9sbFByb3BlcnR5VmFsdWUoc2Nyb2xsaW5nVmlldyk7XG4gICAgICBpZiAoc2Nyb2xsaW5nVmlldyAmJiBzdGFydFNjcm9sbFByb3BlcnR5VmFsdWUgIT09IHVuZGVmaW5lZCAmJiBzdGFydFNjcm9sbFByb3BlcnR5VmFsdWUgIT09IG51bGwpIHtcbiAgICAgICAgY29uc3Qgc2Nyb2xsRGlzdGFuY2UgPSBNYXRoLmFicyhzdGFydFNjcm9sbFByb3BlcnR5VmFsdWUgLSBwb3NpdGlvbik7XG5cbiAgICAgICAgLy8gVGhlIG1vdmVtZW50IHdlIG5lZWQgdG8gcGVyZm9ybSBpcyBsZXNzIHRoYW4gMnB4XG4gICAgICAgIC8vIFRoaXMgd2UgY29uc2lkZXIgYSBzbWFsbCBtb3ZlbWVudCB3aGljaCBzb21lIGJyb3dzZXIgbWF5IG5vdCBwZXJmb3JtIHdoZW5cbiAgICAgICAgLy8gY2hhbmdpbmcgdGhlIHNjcm9sbFRvcC9zY3JvbGxMZWZ0IHByb3BlcnR5XG4gICAgICAgIC8vIFRodXMgaW4gdGhpcyBjYXNlcyB3ZSBkbyBub3Qgc3RvcCB0aGUgc2Nyb2xsIGFuaW1hdGlvbiwgYWx0aG91Z2ggc2V0dGluZyB0aGVcbiAgICAgICAgLy8gc2Nyb2xsVG9wL3Njcm9sbExlZnQgdmFsdWUgXCJmYWlsc1wiXG4gICAgICAgIGNvbnN0IGlzU21hbGxNb3ZlbWVudCA9IHNjcm9sbERpc3RhbmNlIDwgdGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy5fbWluU2Nyb2xsRGlzdGFuY2U7XG5cbiAgICAgICAgaWYgKCF0aGlzLnBhZ2VTY3JvbGxPcHRpb25zLnZlcnRpY2FsU2Nyb2xsaW5nKSB7XG4gICAgICAgICAgc2Nyb2xsaW5nVmlldy5zY3JvbGxMZWZ0ID0gcG9zaXRpb247XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2Nyb2xsaW5nVmlldy5zY3JvbGxUb3AgPSBwb3NpdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJldHVybiB0cnVlIGlmIHNldHRpbmcgdGhlIG5ldyBzY3JvbGxUb3Avc2Nyb2xsTGVmdCB2YWx1ZSB3b3JrZWRcbiAgICAgICAgLy8gV2UgY29uc2lkZXIgdGhhdCBpdCB3b3JrZWQgaWYgdGhlIG5ldyBzY3JvbGxUb3Avc2Nyb2xsTGVmdCB2YWx1ZSBpcyBjbG9zZXIgdG8gdGhlXG4gICAgICAgIC8vIGRlc2lyZWQgc2Nyb2xsVG9wL3Njcm9sbExlZnQgdGhhbiBiZWZvcmUgKGl0IG1pZ2h0IG5vdCBiZSBleGFjdGx5IHRoZSB2YWx1ZSB3ZVxuICAgICAgICAvLyBzZXQgZHVlIHRvIGRwaSBvciByb3VuZGluZyBpcnJlZ3VsYXJpdGllcylcbiAgICAgICAgaWYgKGlzU21hbGxNb3ZlbWVudCB8fCBzY3JvbGxEaXN0YW5jZSA+IE1hdGguYWJzKHRoaXMuZ2V0U2Nyb2xsUHJvcGVydHlWYWx1ZShzY3JvbGxpbmdWaWV3KSAtIHBvc2l0aW9uKSkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBvbmVBbHJlYWR5V29ya2VkO1xuICAgIH0sIGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmlnZ2VyIGZpcmluZyBhIGFuaW1hdGlvbiBmaW5pc2ggZXZlbnRcbiAgICogQHBhcmFtIHZhbHVlIFdoZXRoZXIgdGhlIGFuaW1hdGlvbiBmaW5pc2hlZCBhdCB0aGUgdGFyZ2V0ICh0cnVlKSBvciBnb3QgaW50ZXJydXB0ZWQgKGZhbHNlKVxuICAgKi9cbiAgcHVibGljIGZpcmVFdmVudCh2YWx1ZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmICh0aGlzLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbEZpbmlzaExpc3RlbmVyKSB7XG4gICAgICB0aGlzLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbEZpbmlzaExpc3RlbmVyLmVtaXQodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBdHRhY2ggdGhlIGludGVycnVwdCBsaXN0ZW5lcnMgdG8gdGhlIFBhZ2VTY3JvbGxJbnN0YW5jZSBib2R5LiBUaGUgZ2l2ZW4gaW50ZXJydXB0UmVwb3J0ZXJcbiAgICogd2lsbCBiZSBjYWxsZWQgaWYgYW55IG9mIHRoZSBhdHRhY2hlZCBldmVudHMgaXMgZmlyZWQuXG4gICAqXG4gICAqIFBvc3NpYmx5IGF0dGFjaGVkIGludGVycnVwdExpc3RlbmVycyBhcmUgYXV0b21hdGljYWxseSByZW1vdmVkIGZyb20gdGhlIGJvZHkgYmVmb3JlIHRoZSBuZXcgb25lIHdpbGwgYmUgYXR0YWNoZWQuXG4gICAqL1xuICBwdWJsaWMgYXR0YWNoSW50ZXJydXB0TGlzdGVuZXJzKGludGVycnVwdFJlcG9ydGVyOiBJbnRlcnJ1cHRSZXBvcnRlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLmludGVycnVwdExpc3RlbmVyc0F0dGFjaGVkKSB7XG4gICAgICAvLyBEZXRhY2ggcG9zc2libHkgZXhpc3RpbmcgbGlzdGVuZXJzIGZpcnN0XG4gICAgICB0aGlzLmRldGFjaEludGVycnVwdExpc3RlbmVycygpO1xuICAgIH1cbiAgICB0aGlzLmludGVycnVwdExpc3RlbmVyID0gKGV2ZW50OiBFdmVudCk6IHZvaWQgPT4ge1xuICAgICAgaW50ZXJydXB0UmVwb3J0ZXIucmVwb3J0KGV2ZW50LCB0aGlzKTtcbiAgICB9O1xuICAgIHRoaXMucGFnZVNjcm9sbE9wdGlvbnMuaW50ZXJydXB0RXZlbnRzLmZvckVhY2goXG4gICAgICAoZXZlbnQ6IHN0cmluZykgPT4gdGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIHRoaXMuaW50ZXJydXB0TGlzdGVuZXIpXG4gICAgKTtcbiAgICB0aGlzLmludGVycnVwdExpc3RlbmVyc0F0dGFjaGVkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgZXZlbnQgbGlzdGVuZXJzIGZyb20gdGhlIGJvZHkgYW5kIHN0b3AgbGlzdGVuaW5nIGZvciBldmVudHMgdGhhdCBtaWdodCBiZSB0cmVhdGVkIGFzIFwiYW5pbWF0aW9uXG4gICAqIGludGVycnVwdFwiIGV2ZW50cy5cbiAgICovXG4gIHB1YmxpYyBkZXRhY2hJbnRlcnJ1cHRMaXN0ZW5lcnMoKTogdm9pZCB7XG4gICAgdGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy5pbnRlcnJ1cHRFdmVudHMuZm9yRWFjaChcbiAgICAgIChldmVudDogc3RyaW5nKSA9PiB0aGlzLnBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgdGhpcy5pbnRlcnJ1cHRMaXN0ZW5lcilcbiAgICApO1xuICAgIHRoaXMuaW50ZXJydXB0TGlzdGVuZXJzQXR0YWNoZWQgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2Nyb2xsVGFyZ2V0RWxlbWVudCgpOiBIVE1MRWxlbWVudCB7XG4gICAgaWYgKHR5cGVvZiB0aGlzLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbFRhcmdldCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHRhcmdldFNlbGVjdG9yID0gPHN0cmluZz50aGlzLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbFRhcmdldDtcbiAgICAgIGlmICh0YXJnZXRTZWxlY3Rvci5tYXRjaCgvXiNbXlxcc10rJC9nKSAhPT0gbnVsbCkge1xuICAgICAgICAvLyBJdCdzIGFuIGlkIHNlbGVjdG9yIGFuZCBhIHZhbGlkIGlkLCBhcyBpdCBkb2VzIG5vdCBjb250YWluIGFueSB3aGl0ZSBzcGFjZSBjaGFyYWN0ZXJzXG5cbiAgICAgICAgcmV0dXJuIHRoaXMucGFnZVNjcm9sbE9wdGlvbnMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGFyZ2V0U2VsZWN0b3Iuc3Vic3RyKDEpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIDxIVE1MRWxlbWVudD50aGlzLnBhZ2VTY3JvbGxPcHRpb25zLmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGFyZ2V0U2VsZWN0b3IpO1xuICAgIH1cblxuICAgIHJldHVybiA8SFRNTEVsZW1lbnQ+dGhpcy5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxUYXJnZXQ7XG4gIH1cbn1cblxuLyoqXG4gKiBBbiBJbnRlcmZhY2UgYSBsaXN0ZW5lciBzaG91bGQgaW1wbGVtZW50IHRvIGJlIG5vdGlmaWVkIGFib3V0IHBvc3NpYmxlIGludGVycnVwdCBldmVudHNcbiAqIHRoYXQgaGFwcGVuZWQgZHVlIHRvIHVzZXIgaW50ZXJhY3Rpb24gd2hpbGUgYSBzY3JvbGwgYW5pbWF0aW9uIHRha2VzIHBsYWNlLlxuICpcbiAqIFRoZSBQYWdlU2Nyb2xsU2VydmljZSBwcm92aWRlcyBhbiBpbXBsZW1lbnRhdGlvbiB0byBhIFBhZ2VTY3JvbGxJbnN0YW5jZSB0byBiZSBub3RpZmllZFxuICogYWJvdXQgc2Nyb2xsIGFuaW1hdGlvbiBpbnRlcnJ1cHRzIGFuZCBzdG9wIHJlbGF0ZWQgYW5pbWF0aW9ucy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbnRlcnJ1cHRSZXBvcnRlciB7XG4gIHJlcG9ydChldmVudDogRXZlbnQsIHBhZ2VTY3JvbGxJbnN0YW5jZTogUGFnZVNjcm9sbEluc3RhbmNlKTogdm9pZDtcbn1cbiJdfQ==