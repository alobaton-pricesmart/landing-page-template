/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Inject, Injectable, isDevMode } from '@angular/core';
import { PageScrollInstance } from '../page-scroll-instance';
import { defaultPageScrollConfig, NGXPS_CONFIG } from './config.provider';
import * as i0 from "@angular/core";
import * as i1 from "./config.provider";
var PageScrollService = /** @class */ (function () {
    function PageScrollService(customConfig) {
        var _this = this;
        this.runningInstances = [];
        this.onInterrupted = {
            report: (/**
             * @param {?} event
             * @param {?} pageScrollInstance
             * @return {?}
             */
            function (event, pageScrollInstance) {
                if (!pageScrollInstance.pageScrollOptions.interruptible) {
                    // Non-interruptible anyway, so do not stop anything
                    return;
                }
                /** @type {?} */
                var shouldStop = true;
                if (event.type === 'keyup') {
                    // Only stop if specific keys have been pressed, for all others don't stop anything
                    if (_this.config.interruptKeys.indexOf(((/** @type {?} */ (event))).key) === -1) {
                        // The pressed key is not in the list of interrupting keys
                        shouldStop = false;
                    }
                }
                else if (event.type === 'mousedown') {
                    // For mousedown events we only stop the scroll animation of the mouse has
                    // been clicked inside the scrolling container
                    if (!pageScrollInstance.pageScrollOptions.scrollViews.some((/**
                     * @param {?} scrollingView
                     * @return {?}
                     */
                    function (scrollingView) { return scrollingView.contains((/** @type {?} */ (event.target))); }))) {
                        // Mouse clicked an element which is not inside any of the the scrolling containers
                        shouldStop = false;
                    }
                }
                if (shouldStop) {
                    _this.stopAll(pageScrollInstance.pageScrollOptions.namespace);
                }
            }),
        };
        this.config = tslib_1.__assign({}, defaultPageScrollConfig, customConfig);
        if (PageScrollService.instanceCounter > 0 &&
            (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode()))) {
            console.warn('An instance of PageScrollService already exists, usually ' +
                'including one provider should be enough, so double check.');
        }
        PageScrollService.instanceCounter++;
    }
    /**
     * @private
     * @param {?} interrupted
     * @param {?} pageScrollInstance
     * @return {?}
     */
    PageScrollService.prototype.stopInternal = /**
     * @private
     * @param {?} interrupted
     * @param {?} pageScrollInstance
     * @return {?}
     */
    function (interrupted, pageScrollInstance) {
        /** @type {?} */
        var index = this.runningInstances.indexOf(pageScrollInstance);
        if (index >= 0) {
            this.runningInstances.splice(index, 1);
        }
        if (pageScrollInstance.interruptListenersAttached) {
            pageScrollInstance.detachInterruptListeners();
        }
        if (pageScrollInstance.timer) {
            // Clear/Stop the timer
            clearInterval(pageScrollInstance.timer);
            // Clear the reference to this timer
            pageScrollInstance.timer = undefined;
            pageScrollInstance.fireEvent(!interrupted);
            return true;
        }
        return false;
    };
    /**
     * @param {?} options
     * @return {?}
     */
    PageScrollService.prototype.create = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        return new PageScrollInstance((/** @type {?} */ (tslib_1.__assign({}, this.config, options))));
    };
    /**
     * Start a scroll animation. All properties of the animation are stored in the given {@link PageScrollInstance} object.
     *
     * This is the core functionality of the whole library.
     */
    // tslint:disable-next-line:cyclomatic-complexity
    /**
     * Start a scroll animation. All properties of the animation are stored in the given {\@link PageScrollInstance} object.
     *
     * This is the core functionality of the whole library.
     * @param {?} pageScrollInstance
     * @return {?}
     */
    // tslint:disable-next-line:cyclomatic-complexity
    PageScrollService.prototype.start = /**
     * Start a scroll animation. All properties of the animation are stored in the given {\@link PageScrollInstance} object.
     *
     * This is the core functionality of the whole library.
     * @param {?} pageScrollInstance
     * @return {?}
     */
    // tslint:disable-next-line:cyclomatic-complexity
    function (pageScrollInstance) {
        var _this = this;
        // Merge the default options in the pageScrollInstance options
        pageScrollInstance.pageScrollOptions = (/** @type {?} */ (tslib_1.__assign({}, this.config, pageScrollInstance.pageScrollOptions)));
        // Stop all possibly running scroll animations in the same namespace
        this.stopAll(pageScrollInstance.pageScrollOptions.namespace);
        if (pageScrollInstance.pageScrollOptions.scrollViews === null || pageScrollInstance.pageScrollOptions.scrollViews.length === 0) {
            // No scrollViews specified, thus we can't animate anything
            if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                console.warn('No scrollViews specified, thus ngx-page-scroll does not know which DOM elements to scroll');
            }
            return;
        }
        /** @type {?} */
        var startScrollPositionFound = false;
        /** @type {?} */
        var scrollRange = pageScrollInstance.getScrollClientPropertyValue(pageScrollInstance.pageScrollOptions.scrollViews[0]);
        // Reset start scroll position to 0. If any of the scrollViews has a different one, it will be extracted next
        pageScrollInstance.startScrollPosition = 0;
        // Get the start scroll position from the scrollViews (e.g. if the user already scrolled down the content)
        pageScrollInstance.pageScrollOptions.scrollViews.forEach((/**
         * @param {?} scrollingView
         * @return {?}
         */
        function (scrollingView) {
            if (scrollingView === undefined || scrollingView === null) {
                return;
            }
            // Get the scrollTop or scrollLeft value of the first scrollingView that returns a value for its "scrollTop"
            // or "scrollLeft" property that is not undefined and unequal to 0
            /** @type {?} */
            var scrollPosition = pageScrollInstance.getScrollPropertyValue(scrollingView);
            if (!startScrollPositionFound && scrollPosition) {
                // We found a scrollingView that does not have scrollTop or scrollLeft 0
                // Return the scroll position value, as this will be our startScrollPosition
                pageScrollInstance.startScrollPosition = scrollPosition;
                startScrollPositionFound = true;
                // Remember te scrollRange of this scrollingView
                scrollRange = pageScrollInstance.getScrollClientPropertyValue(scrollingView);
            }
        }));
        /** @type {?} */
        var pageScrollOffset = pageScrollInstance.getCurrentOffset();
        // Calculate the target position that the scroll animation should go to
        /** @type {?} */
        var scrollTargetPosition = pageScrollInstance.extractScrollTargetPosition();
        pageScrollInstance.targetScrollPosition = Math.round((pageScrollInstance.pageScrollOptions.verticalScrolling ? scrollTargetPosition.top : scrollTargetPosition.left) - pageScrollOffset);
        // Calculate the distance we need to go in total
        pageScrollInstance.distanceToScroll = pageScrollInstance.targetScrollPosition - pageScrollInstance.startScrollPosition;
        if (isNaN(pageScrollInstance.distanceToScroll)) {
            // We weren't able to find the target position, maybe the element does not exist?
            if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                console.log('Scrolling not possible, as we can\'t find the specified target');
            }
            pageScrollInstance.fireEvent(false);
            return;
        }
        // We're at the final destination already
        // OR we need to scroll down but are already at the end
        // OR we need to scroll up but are at the top already
        /** @type {?} */
        var allReadyAtDestination = Math.abs(pageScrollInstance.distanceToScroll) < pageScrollInstance.pageScrollOptions._minScrollDistance;
        // Check how long we need to scroll if a speed option is given
        // Default executionDuration is the specified duration
        pageScrollInstance.executionDuration = pageScrollInstance.pageScrollOptions.duration;
        // Maybe we need to pay attention to the speed option?
        if ((pageScrollInstance.pageScrollOptions.speed !== undefined && pageScrollInstance.pageScrollOptions.speed !== null) &&
            (pageScrollInstance.pageScrollOptions.duration === undefined || pageScrollInstance.pageScrollOptions.duration === null)) {
            // Speed option is set and no duration => calculate duration based on speed and scroll distance
            pageScrollInstance.executionDuration =
                Math.abs(pageScrollInstance.distanceToScroll) / pageScrollInstance.pageScrollOptions.speed * 1000;
        }
        // We should go there directly, as our "animation" would have one big step
        // only anyway and this way we save the interval stuff
        /** @type {?} */
        var tooShortInterval = pageScrollInstance.executionDuration <= pageScrollInstance.pageScrollOptions._interval;
        if (allReadyAtDestination || tooShortInterval) {
            if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                if (allReadyAtDestination) {
                    console.log('Scrolling not possible, as we can\'t get any closer to the destination');
                }
                else {
                    console.log('Scroll duration shorter that interval length, jumping to target');
                }
            }
            pageScrollInstance.setScrollPosition(pageScrollInstance.targetScrollPosition);
            pageScrollInstance.fireEvent(true);
            return;
        }
        if (!pageScrollInstance.pageScrollOptions.scrollInView) {
            /** @type {?} */
            var alreadyInView = pageScrollInstance.targetScrollPosition > pageScrollInstance.startScrollPosition &&
                pageScrollInstance.targetScrollPosition <= pageScrollInstance.startScrollPosition + scrollRange;
            if (alreadyInView) {
                if (this.config._logLevel >= 2 || (this.config._logLevel >= 1 && isDevMode())) {
                    console.log('Not scrolling, as target already in view');
                }
                pageScrollInstance.fireEvent(true);
                return;
            }
        }
        // Register the interrupt listeners if we want an interruptible scroll animation
        if (pageScrollInstance.pageScrollOptions.interruptible) {
            pageScrollInstance.attachInterruptListeners(this.onInterrupted);
        }
        // Let's get started, get the start time...
        pageScrollInstance.startTime = new Date().getTime();
        // .. and calculate the end time (when we need to finish at last)
        pageScrollInstance.endTime = pageScrollInstance.startTime + pageScrollInstance.executionDuration;
        pageScrollInstance.timer = setInterval((/**
         * @param {?} _pageScrollInstance
         * @return {?}
         */
        function (_pageScrollInstance) {
            // Take the current time
            /** @type {?} */
            var currentTime = new Date().getTime();
            // Determine the new scroll position
            /** @type {?} */
            var newScrollPosition;
            /** @type {?} */
            var stopNow = false;
            if (_pageScrollInstance.endTime <= currentTime) {
                // We're over the time already, so go the targetScrollPosition (aka destination)
                newScrollPosition = _pageScrollInstance.targetScrollPosition;
                stopNow = true;
            }
            else {
                // Calculate the scroll position based on the current time using the easing function
                newScrollPosition = Math.round(_pageScrollInstance.pageScrollOptions.easingLogic(currentTime - _pageScrollInstance.startTime, _pageScrollInstance.startScrollPosition, _pageScrollInstance.distanceToScroll, _pageScrollInstance.executionDuration));
            }
            if (_this.config._logLevel >= 5 && isDevMode()) {
                console.warn('Scroll Position: ' + newScrollPosition);
            }
            // Set the new scrollPosition to all scrollViews elements
            if (!_pageScrollInstance.setScrollPosition(newScrollPosition)) {
                // Setting the new scrollTop/scrollLeft value failed for all ScrollViews
                // early stop the scroll animation to save resources
                stopNow = true;
            }
            // At the end do the internal stop maintenance and fire the pageScrollFinish event
            // (otherwise the event might arrive at "too early")
            if (stopNow) {
                _this.stopInternal(false, _pageScrollInstance);
            }
        }), this.config._interval, pageScrollInstance);
        // Register the instance as running one
        this.runningInstances.push(pageScrollInstance);
    };
    /**
     * @param {?} options
     * @return {?}
     */
    PageScrollService.prototype.scroll = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        this.start(this.create(options));
    };
    /**
     * Stop all running scroll animations. Optionally limit to stop only the ones of specific namespace.
     */
    /**
     * Stop all running scroll animations. Optionally limit to stop only the ones of specific namespace.
     * @param {?=} namespace
     * @return {?}
     */
    PageScrollService.prototype.stopAll = /**
     * Stop all running scroll animations. Optionally limit to stop only the ones of specific namespace.
     * @param {?=} namespace
     * @return {?}
     */
    function (namespace) {
        if (this.runningInstances.length > 0) {
            /** @type {?} */
            var stoppedSome = false;
            for (var i = 0; i < this.runningInstances.length; ++i) {
                /** @type {?} */
                var pageScrollInstance = this.runningInstances[i];
                if (!namespace || pageScrollInstance.pageScrollOptions.namespace === namespace) {
                    stoppedSome = true;
                    this.stopInternal(true, pageScrollInstance);
                    // Decrease the counter, as we removed an item from the array we iterate over
                    i--;
                }
            }
            return stoppedSome;
        }
        return false;
    };
    /**
     * @param {?} pageScrollInstance
     * @return {?}
     */
    PageScrollService.prototype.stop = /**
     * @param {?} pageScrollInstance
     * @return {?}
     */
    function (pageScrollInstance) {
        return this.stopInternal(true, pageScrollInstance);
    };
    PageScrollService.instanceCounter = 0;
    PageScrollService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root',
                },] }
    ];
    /** @nocollapse */
    PageScrollService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [NGXPS_CONFIG,] }] }
    ]; };
    /** @nocollapse */ PageScrollService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function PageScrollService_Factory() { return new PageScrollService(i0.ɵɵinject(i1.NGXPS_CONFIG)); }, token: PageScrollService, providedIn: "root" });
    return PageScrollService;
}());
export { PageScrollService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    PageScrollService.instanceCounter;
    /**
     * @type {?}
     * @private
     */
    PageScrollService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    PageScrollService.prototype.runningInstances;
    /**
     * @type {?}
     * @private
     */
    PageScrollService.prototype.onInterrupted;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXBhZ2Utc2Nyb2xsLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtcGFnZS1zY3JvbGwtY29yZS8iLCJzb3VyY2VzIjpbImxpYi9wcm92aWRlcnMvbmd4LXBhZ2Utc2Nyb2xsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHOUQsT0FBTyxFQUFxQixrQkFBa0IsRUFBcUIsTUFBTSx5QkFBeUIsQ0FBQztBQUNuRyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7OztBQUUxRTtJQTBRRSwyQkFBa0MsWUFBOEI7UUFBaEUsaUJBU0M7UUEzUU8scUJBQWdCLEdBQXlCLEVBQUUsQ0FBQztRQUU1QyxrQkFBYSxHQUFzQjtZQUN6QyxNQUFNOzs7OztZQUFFLFVBQUMsS0FBWSxFQUFFLGtCQUFzQztnQkFDM0QsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRTtvQkFDdkQsb0RBQW9EO29CQUNwRCxPQUFPO2lCQUNSOztvQkFFRyxVQUFVLEdBQUcsSUFBSTtnQkFFckIsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRTtvQkFDMUIsbUZBQW1GO29CQUNuRixJQUFJLEtBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLG1CQUFlLEtBQUssRUFBQSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7d0JBQ3hFLDBEQUEwRDt3QkFDMUQsVUFBVSxHQUFHLEtBQUssQ0FBQztxQkFDcEI7aUJBQ0Y7cUJBQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRTtvQkFDckMsMEVBQTBFO29CQUMxRSw4Q0FBOEM7b0JBQzlDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FB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QUFFLGtCQUFrQixDQUFDLENBQUM7b0JBQzVDLDZFQUE2RTtvQkFDN0UsQ0FBQyxFQUFFLENBQUM7aUJBQ0w7YUFDRjtZQUVELE9BQU8sV0FBVyxDQUFDO1NBQ3BCO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs7OztJQUVNLGdDQUFJOzs7O0lBQVgsVUFBWSxrQkFBc0M7UUFDaEQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFwUWMsaUNBQWUsR0FBRyxDQUFDLENBQUM7O2dCQUpwQyxVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dEQXdRYyxNQUFNLFNBQUMsWUFBWTs7OzRCQWhSbEM7Q0EwUkMsQUFwUkQsSUFvUkM7U0FqUlksaUJBQWlCOzs7Ozs7SUFDNUIsa0NBQW1DOzs7OztJQUVuQyxtQ0FBMEM7Ozs7O0lBRTFDLDZDQUFvRDs7Ozs7SUFFcEQsMENBNEJFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBpc0Rldk1vZGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgUGFnZVNjcm9sbENvbmZpZyB9IGZyb20gJy4uL3R5cGVzL3BhZ2Utc2Nyb2xsLmNvbmZpZyc7XG5pbXBvcnQgeyBJbnRlcnJ1cHRSZXBvcnRlciwgUGFnZVNjcm9sbEluc3RhbmNlLCBQYWdlU2Nyb2xsT3B0aW9ucyB9IGZyb20gJy4uL3BhZ2Utc2Nyb2xsLWluc3RhbmNlJztcbmltcG9ydCB7IGRlZmF1bHRQYWdlU2Nyb2xsQ29uZmlnLCBOR1hQU19DT05GSUcgfSBmcm9tICcuL2NvbmZpZy5wcm92aWRlcic7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBQYWdlU2Nyb2xsU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlQ291bnRlciA9IDA7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IFBhZ2VTY3JvbGxDb25maWc7XG5cbiAgcHJpdmF0ZSBydW5uaW5nSW5zdGFuY2VzOiBQYWdlU2Nyb2xsSW5zdGFuY2VbXSA9IFtdO1xuXG4gIHByaXZhdGUgb25JbnRlcnJ1cHRlZDogSW50ZXJydXB0UmVwb3J0ZXIgPSB7XG4gICAgcmVwb3J0OiAoZXZlbnQ6IEV2ZW50LCBwYWdlU2Nyb2xsSW5zdGFuY2U6IFBhZ2VTY3JvbGxJbnN0YW5jZSk6IHZvaWQgPT4ge1xuICAgICAgaWYgKCFwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuaW50ZXJydXB0aWJsZSkge1xuICAgICAgICAvLyBOb24taW50ZXJydXB0aWJsZSBhbnl3YXksIHNvIGRvIG5vdCBzdG9wIGFueXRoaW5nXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbGV0IHNob3VsZFN0b3AgPSB0cnVlO1xuXG4gICAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2tleXVwJykge1xuICAgICAgICAvLyBPbmx5IHN0b3AgaWYgc3BlY2lmaWMga2V5cyBoYXZlIGJlZW4gcHJlc3NlZCwgZm9yIGFsbCBvdGhlcnMgZG9uJ3Qgc3RvcCBhbnl0aGluZ1xuICAgICAgICBpZiAodGhpcy5jb25maWcuaW50ZXJydXB0S2V5cy5pbmRleE9mKCg8S2V5Ym9hcmRFdmVudD5ldmVudCkua2V5KSA9PT0gLTEpIHtcbiAgICAgICAgICAvLyBUaGUgcHJlc3NlZCBrZXkgaXMgbm90IGluIHRoZSBsaXN0IG9mIGludGVycnVwdGluZyBrZXlzXG4gICAgICAgICAgc2hvdWxkU3RvcCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09ICdtb3VzZWRvd24nKSB7XG4gICAgICAgIC8vIEZvciBtb3VzZWRvd24gZXZlbnRzIHdlIG9ubHkgc3RvcCB0aGUgc2Nyb2xsIGFuaW1hdGlvbiBvZiB0aGUgbW91c2UgaGFzXG4gICAgICAgIC8vIGJlZW4gY2xpY2tlZCBpbnNpZGUgdGhlIHNjcm9sbGluZyBjb250YWluZXJcbiAgICAgICAgaWYgKCFwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuc2Nyb2xsVmlld3Muc29tZShzY3JvbGxpbmdWaWV3ID0+IHNjcm9sbGluZ1ZpZXcuY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpKSkge1xuICAgICAgICAgIC8vIE1vdXNlIGNsaWNrZWQgYW4gZWxlbWVudCB3aGljaCBpcyBub3QgaW5zaWRlIGFueSBvZiB0aGUgdGhlIHNjcm9sbGluZyBjb250YWluZXJzXG4gICAgICAgICAgc2hvdWxkU3RvcCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChzaG91bGRTdG9wKSB7XG4gICAgICAgIHRoaXMuc3RvcEFsbChwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMubmFtZXNwYWNlKTtcbiAgICAgIH1cbiAgICB9LFxuICB9O1xuXG4gIHByaXZhdGUgc3RvcEludGVybmFsKGludGVycnVwdGVkOiBib29sZWFuLCBwYWdlU2Nyb2xsSW5zdGFuY2U6IFBhZ2VTY3JvbGxJbnN0YW5jZSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGluZGV4OiBudW1iZXIgPSB0aGlzLnJ1bm5pbmdJbnN0YW5jZXMuaW5kZXhPZihwYWdlU2Nyb2xsSW5zdGFuY2UpO1xuICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICB0aGlzLnJ1bm5pbmdJbnN0YW5jZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG5cbiAgICBpZiAocGFnZVNjcm9sbEluc3RhbmNlLmludGVycnVwdExpc3RlbmVyc0F0dGFjaGVkKSB7XG4gICAgICBwYWdlU2Nyb2xsSW5zdGFuY2UuZGV0YWNoSW50ZXJydXB0TGlzdGVuZXJzKCk7XG4gICAgfVxuXG4gICAgaWYgKHBhZ2VTY3JvbGxJbnN0YW5jZS50aW1lcikge1xuICAgICAgLy8gQ2xlYXIvU3RvcCB0aGUgdGltZXJcbiAgICAgIGNsZWFySW50ZXJ2YWwocGFnZVNjcm9sbEluc3RhbmNlLnRpbWVyKTtcbiAgICAgIC8vIENsZWFyIHRoZSByZWZlcmVuY2UgdG8gdGhpcyB0aW1lclxuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLnRpbWVyID0gdW5kZWZpbmVkO1xuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLmZpcmVFdmVudCghaW50ZXJydXB0ZWQpO1xuXG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlKG9wdGlvbnM6IFBhZ2VTY3JvbGxPcHRpb25zKTogUGFnZVNjcm9sbEluc3RhbmNlIHtcbiAgICByZXR1cm4gbmV3IFBhZ2VTY3JvbGxJbnN0YW5jZSh7Li4udGhpcy5jb25maWcsIC4uLm9wdGlvbnN9IGFzIFBhZ2VTY3JvbGxPcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCBhIHNjcm9sbCBhbmltYXRpb24uIEFsbCBwcm9wZXJ0aWVzIG9mIHRoZSBhbmltYXRpb24gYXJlIHN0b3JlZCBpbiB0aGUgZ2l2ZW4ge0BsaW5rIFBhZ2VTY3JvbGxJbnN0YW5jZX0gb2JqZWN0LlxuICAgKlxuICAgKiBUaGlzIGlzIHRoZSBjb3JlIGZ1bmN0aW9uYWxpdHkgb2YgdGhlIHdob2xlIGxpYnJhcnkuXG4gICAqL1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y3ljbG9tYXRpYy1jb21wbGV4aXR5XG4gIHB1YmxpYyBzdGFydChwYWdlU2Nyb2xsSW5zdGFuY2U6IFBhZ2VTY3JvbGxJbnN0YW5jZSk6IHZvaWQge1xuICAgIC8vIE1lcmdlIHRoZSBkZWZhdWx0IG9wdGlvbnMgaW4gdGhlIHBhZ2VTY3JvbGxJbnN0YW5jZSBvcHRpb25zXG4gICAgcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zID0gey4uLnRoaXMuY29uZmlnLCAuLi5wYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnN9IGFzIFBhZ2VTY3JvbGxPcHRpb25zO1xuXG4gICAgLy8gU3RvcCBhbGwgcG9zc2libHkgcnVubmluZyBzY3JvbGwgYW5pbWF0aW9ucyBpbiB0aGUgc2FtZSBuYW1lc3BhY2VcbiAgICB0aGlzLnN0b3BBbGwocGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLm5hbWVzcGFjZSk7XG5cbiAgICBpZiAocGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbFZpZXdzID09PSBudWxsIHx8IHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3cy5sZW5ndGggPT09IDApIHtcbiAgICAgIC8vIE5vIHNjcm9sbFZpZXdzIHNwZWNpZmllZCwgdGh1cyB3ZSBjYW4ndCBhbmltYXRlIGFueXRoaW5nXG4gICAgICBpZiAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDIgfHwgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAxICYmIGlzRGV2TW9kZSgpKSkge1xuICAgICAgICBjb25zb2xlLndhcm4oJ05vIHNjcm9sbFZpZXdzIHNwZWNpZmllZCwgdGh1cyBuZ3gtcGFnZS1zY3JvbGwgZG9lcyBub3Qga25vdyB3aGljaCBET00gZWxlbWVudHMgdG8gc2Nyb2xsJyk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc3RhcnRTY3JvbGxQb3NpdGlvbkZvdW5kID0gZmFsc2U7XG4gICAgbGV0IHNjcm9sbFJhbmdlID0gcGFnZVNjcm9sbEluc3RhbmNlLmdldFNjcm9sbENsaWVudFByb3BlcnR5VmFsdWUocGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbFZpZXdzWzBdKTtcbiAgICAvLyBSZXNldCBzdGFydCBzY3JvbGwgcG9zaXRpb24gdG8gMC4gSWYgYW55IG9mIHRoZSBzY3JvbGxWaWV3cyBoYXMgYSBkaWZmZXJlbnQgb25lLCBpdCB3aWxsIGJlIGV4dHJhY3RlZCBuZXh0XG4gICAgcGFnZVNjcm9sbEluc3RhbmNlLnN0YXJ0U2Nyb2xsUG9zaXRpb24gPSAwO1xuXG4gICAgLy8gR2V0IHRoZSBzdGFydCBzY3JvbGwgcG9zaXRpb24gZnJvbSB0aGUgc2Nyb2xsVmlld3MgKGUuZy4gaWYgdGhlIHVzZXIgYWxyZWFkeSBzY3JvbGxlZCBkb3duIHRoZSBjb250ZW50KVxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5zY3JvbGxWaWV3cy5mb3JFYWNoKHNjcm9sbGluZ1ZpZXcgPT4ge1xuICAgICAgaWYgKHNjcm9sbGluZ1ZpZXcgPT09IHVuZGVmaW5lZCB8fCBzY3JvbGxpbmdWaWV3ID09PSBudWxsKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIC8vIEdldCB0aGUgc2Nyb2xsVG9wIG9yIHNjcm9sbExlZnQgdmFsdWUgb2YgdGhlIGZpcnN0IHNjcm9sbGluZ1ZpZXcgdGhhdCByZXR1cm5zIGEgdmFsdWUgZm9yIGl0cyBcInNjcm9sbFRvcFwiXG4gICAgICAvLyBvciBcInNjcm9sbExlZnRcIiBwcm9wZXJ0eSB0aGF0IGlzIG5vdCB1bmRlZmluZWQgYW5kIHVuZXF1YWwgdG8gMFxuXG4gICAgICBjb25zdCBzY3JvbGxQb3NpdGlvbiA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5nZXRTY3JvbGxQcm9wZXJ0eVZhbHVlKHNjcm9sbGluZ1ZpZXcpO1xuICAgICAgaWYgKCFzdGFydFNjcm9sbFBvc2l0aW9uRm91bmQgJiYgc2Nyb2xsUG9zaXRpb24pIHtcbiAgICAgICAgLy8gV2UgZm91bmQgYSBzY3JvbGxpbmdWaWV3IHRoYXQgZG9lcyBub3QgaGF2ZSBzY3JvbGxUb3Agb3Igc2Nyb2xsTGVmdCAwXG5cbiAgICAgICAgLy8gUmV0dXJuIHRoZSBzY3JvbGwgcG9zaXRpb24gdmFsdWUsIGFzIHRoaXMgd2lsbCBiZSBvdXIgc3RhcnRTY3JvbGxQb3NpdGlvblxuICAgICAgICBwYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRTY3JvbGxQb3NpdGlvbiA9IHNjcm9sbFBvc2l0aW9uO1xuICAgICAgICBzdGFydFNjcm9sbFBvc2l0aW9uRm91bmQgPSB0cnVlO1xuXG4gICAgICAgIC8vIFJlbWVtYmVyIHRlIHNjcm9sbFJhbmdlIG9mIHRoaXMgc2Nyb2xsaW5nVmlld1xuICAgICAgICBzY3JvbGxSYW5nZSA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5nZXRTY3JvbGxDbGllbnRQcm9wZXJ0eVZhbHVlKHNjcm9sbGluZ1ZpZXcpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgcGFnZVNjcm9sbE9mZnNldCA9IHBhZ2VTY3JvbGxJbnN0YW5jZS5nZXRDdXJyZW50T2Zmc2V0KCk7XG5cbiAgICAvLyBDYWxjdWxhdGUgdGhlIHRhcmdldCBwb3NpdGlvbiB0aGF0IHRoZSBzY3JvbGwgYW5pbWF0aW9uIHNob3VsZCBnbyB0b1xuXG4gICAgY29uc3Qgc2Nyb2xsVGFyZ2V0UG9zaXRpb24gPSBwYWdlU2Nyb2xsSW5zdGFuY2UuZXh0cmFjdFNjcm9sbFRhcmdldFBvc2l0aW9uKCk7XG4gICAgcGFnZVNjcm9sbEluc3RhbmNlLnRhcmdldFNjcm9sbFBvc2l0aW9uID0gTWF0aC5yb3VuZChcbiAgICAgIChwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMudmVydGljYWxTY3JvbGxpbmcgPyBzY3JvbGxUYXJnZXRQb3NpdGlvbi50b3AgOiBzY3JvbGxUYXJnZXRQb3NpdGlvbi5sZWZ0KSAtIHBhZ2VTY3JvbGxPZmZzZXQpO1xuXG4gICAgLy8gQ2FsY3VsYXRlIHRoZSBkaXN0YW5jZSB3ZSBuZWVkIHRvIGdvIGluIHRvdGFsXG4gICAgcGFnZVNjcm9sbEluc3RhbmNlLmRpc3RhbmNlVG9TY3JvbGwgPSBwYWdlU2Nyb2xsSW5zdGFuY2UudGFyZ2V0U2Nyb2xsUG9zaXRpb24gLSBwYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRTY3JvbGxQb3NpdGlvbjtcblxuICAgIGlmIChpc05hTihwYWdlU2Nyb2xsSW5zdGFuY2UuZGlzdGFuY2VUb1Njcm9sbCkpIHtcbiAgICAgIC8vIFdlIHdlcmVuJ3QgYWJsZSB0byBmaW5kIHRoZSB0YXJnZXQgcG9zaXRpb24sIG1heWJlIHRoZSBlbGVtZW50IGRvZXMgbm90IGV4aXN0P1xuXG4gICAgICBpZiAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDIgfHwgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAxICYmIGlzRGV2TW9kZSgpKSkge1xuICAgICAgICBjb25zb2xlLmxvZygnU2Nyb2xsaW5nIG5vdCBwb3NzaWJsZSwgYXMgd2UgY2FuXFwndCBmaW5kIHRoZSBzcGVjaWZpZWQgdGFyZ2V0Jyk7XG4gICAgICB9XG4gICAgICBwYWdlU2Nyb2xsSW5zdGFuY2UuZmlyZUV2ZW50KGZhbHNlKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFdlJ3JlIGF0IHRoZSBmaW5hbCBkZXN0aW5hdGlvbiBhbHJlYWR5XG4gICAgLy8gT1Igd2UgbmVlZCB0byBzY3JvbGwgZG93biBidXQgYXJlIGFscmVhZHkgYXQgdGhlIGVuZFxuICAgIC8vIE9SIHdlIG5lZWQgdG8gc2Nyb2xsIHVwIGJ1dCBhcmUgYXQgdGhlIHRvcCBhbHJlYWR5XG4gICAgY29uc3QgYWxsUmVhZHlBdERlc3RpbmF0aW9uID0gTWF0aC5hYnMocGFnZVNjcm9sbEluc3RhbmNlLmRpc3RhbmNlVG9TY3JvbGwpIDwgcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLl9taW5TY3JvbGxEaXN0YW5jZTtcblxuICAgIC8vIENoZWNrIGhvdyBsb25nIHdlIG5lZWQgdG8gc2Nyb2xsIGlmIGEgc3BlZWQgb3B0aW9uIGlzIGdpdmVuXG4gICAgLy8gRGVmYXVsdCBleGVjdXRpb25EdXJhdGlvbiBpcyB0aGUgc3BlY2lmaWVkIGR1cmF0aW9uXG4gICAgcGFnZVNjcm9sbEluc3RhbmNlLmV4ZWN1dGlvbkR1cmF0aW9uID0gcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLmR1cmF0aW9uO1xuICAgIC8vIE1heWJlIHdlIG5lZWQgdG8gcGF5IGF0dGVudGlvbiB0byB0aGUgc3BlZWQgb3B0aW9uP1xuICAgIGlmICgocGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNwZWVkICE9PSB1bmRlZmluZWQgJiYgcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNwZWVkICE9PSBudWxsKSAmJlxuICAgICAgKHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5kdXJhdGlvbiA9PT0gdW5kZWZpbmVkIHx8IHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5kdXJhdGlvbiA9PT0gbnVsbCkpIHtcbiAgICAgIC8vIFNwZWVkIG9wdGlvbiBpcyBzZXQgYW5kIG5vIGR1cmF0aW9uID0+IGNhbGN1bGF0ZSBkdXJhdGlvbiBiYXNlZCBvbiBzcGVlZCBhbmQgc2Nyb2xsIGRpc3RhbmNlXG4gICAgICBwYWdlU2Nyb2xsSW5zdGFuY2UuZXhlY3V0aW9uRHVyYXRpb24gPVxuICAgICAgICBNYXRoLmFicyhwYWdlU2Nyb2xsSW5zdGFuY2UuZGlzdGFuY2VUb1Njcm9sbCkgLyBwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMuc3BlZWQgKiAxMDAwO1xuICAgIH1cblxuICAgIC8vIFdlIHNob3VsZCBnbyB0aGVyZSBkaXJlY3RseSwgYXMgb3VyIFwiYW5pbWF0aW9uXCIgd291bGQgaGF2ZSBvbmUgYmlnIHN0ZXBcbiAgICAvLyBvbmx5IGFueXdheSBhbmQgdGhpcyB3YXkgd2Ugc2F2ZSB0aGUgaW50ZXJ2YWwgc3R1ZmZcbiAgICBjb25zdCB0b29TaG9ydEludGVydmFsID0gcGFnZVNjcm9sbEluc3RhbmNlLmV4ZWN1dGlvbkR1cmF0aW9uIDw9IHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5faW50ZXJ2YWw7XG5cbiAgICBpZiAoYWxsUmVhZHlBdERlc3RpbmF0aW9uIHx8IHRvb1Nob3J0SW50ZXJ2YWwpIHtcbiAgICAgIGlmICh0aGlzLmNvbmZpZy5fbG9nTGV2ZWwgPj0gMiB8fCAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDEgJiYgaXNEZXZNb2RlKCkpKSB7XG4gICAgICAgIGlmIChhbGxSZWFkeUF0RGVzdGluYXRpb24pIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnU2Nyb2xsaW5nIG5vdCBwb3NzaWJsZSwgYXMgd2UgY2FuXFwndCBnZXQgYW55IGNsb3NlciB0byB0aGUgZGVzdGluYXRpb24nKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnU2Nyb2xsIGR1cmF0aW9uIHNob3J0ZXIgdGhhdCBpbnRlcnZhbCBsZW5ndGgsIGp1bXBpbmcgdG8gdGFyZ2V0Jyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5zZXRTY3JvbGxQb3NpdGlvbihwYWdlU2Nyb2xsSW5zdGFuY2UudGFyZ2V0U2Nyb2xsUG9zaXRpb24pO1xuICAgICAgcGFnZVNjcm9sbEluc3RhbmNlLmZpcmVFdmVudCh0cnVlKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghcGFnZVNjcm9sbEluc3RhbmNlLnBhZ2VTY3JvbGxPcHRpb25zLnNjcm9sbEluVmlldykge1xuICAgICAgY29uc3QgYWxyZWFkeUluVmlldyA9IHBhZ2VTY3JvbGxJbnN0YW5jZS50YXJnZXRTY3JvbGxQb3NpdGlvbiA+IHBhZ2VTY3JvbGxJbnN0YW5jZS5zdGFydFNjcm9sbFBvc2l0aW9uICYmXG4gICAgICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS50YXJnZXRTY3JvbGxQb3NpdGlvbiA8PSBwYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRTY3JvbGxQb3NpdGlvbiArIHNjcm9sbFJhbmdlO1xuICAgICAgaWYgKGFscmVhZHlJblZpZXcpIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAyIHx8ICh0aGlzLmNvbmZpZy5fbG9nTGV2ZWwgPj0gMSAmJiBpc0Rldk1vZGUoKSkpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnTm90IHNjcm9sbGluZywgYXMgdGFyZ2V0IGFscmVhZHkgaW4gdmlldycpO1xuICAgICAgICB9XG4gICAgICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5maXJlRXZlbnQodHJ1ZSk7XG5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFJlZ2lzdGVyIHRoZSBpbnRlcnJ1cHQgbGlzdGVuZXJzIGlmIHdlIHdhbnQgYW4gaW50ZXJydXB0aWJsZSBzY3JvbGwgYW5pbWF0aW9uXG4gICAgaWYgKHBhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5pbnRlcnJ1cHRpYmxlKSB7XG4gICAgICBwYWdlU2Nyb2xsSW5zdGFuY2UuYXR0YWNoSW50ZXJydXB0TGlzdGVuZXJzKHRoaXMub25JbnRlcnJ1cHRlZCk7XG4gICAgfVxuXG4gICAgLy8gTGV0J3MgZ2V0IHN0YXJ0ZWQsIGdldCB0aGUgc3RhcnQgdGltZS4uLlxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5zdGFydFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAvLyAuLiBhbmQgY2FsY3VsYXRlIHRoZSBlbmQgdGltZSAod2hlbiB3ZSBuZWVkIHRvIGZpbmlzaCBhdCBsYXN0KVxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS5lbmRUaW1lID0gcGFnZVNjcm9sbEluc3RhbmNlLnN0YXJ0VGltZSArIHBhZ2VTY3JvbGxJbnN0YW5jZS5leGVjdXRpb25EdXJhdGlvbjtcblxuICAgIHBhZ2VTY3JvbGxJbnN0YW5jZS50aW1lciA9IHNldEludGVydmFsKChfcGFnZVNjcm9sbEluc3RhbmNlOiBQYWdlU2Nyb2xsSW5zdGFuY2UpID0+IHtcbiAgICAgIC8vIFRha2UgdGhlIGN1cnJlbnQgdGltZVxuICAgICAgY29uc3QgY3VycmVudFRpbWU6IG51bWJlciA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgdGhlIG5ldyBzY3JvbGwgcG9zaXRpb25cbiAgICAgIGxldCBuZXdTY3JvbGxQb3NpdGlvbjogbnVtYmVyO1xuICAgICAgbGV0IHN0b3BOb3cgPSBmYWxzZTtcbiAgICAgIGlmIChfcGFnZVNjcm9sbEluc3RhbmNlLmVuZFRpbWUgPD0gY3VycmVudFRpbWUpIHtcbiAgICAgICAgLy8gV2UncmUgb3ZlciB0aGUgdGltZSBhbHJlYWR5LCBzbyBnbyB0aGUgdGFyZ2V0U2Nyb2xsUG9zaXRpb24gKGFrYSBkZXN0aW5hdGlvbilcbiAgICAgICAgbmV3U2Nyb2xsUG9zaXRpb24gPSBfcGFnZVNjcm9sbEluc3RhbmNlLnRhcmdldFNjcm9sbFBvc2l0aW9uO1xuICAgICAgICBzdG9wTm93ID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgc2Nyb2xsIHBvc2l0aW9uIGJhc2VkIG9uIHRoZSBjdXJyZW50IHRpbWUgdXNpbmcgdGhlIGVhc2luZyBmdW5jdGlvblxuICAgICAgICBuZXdTY3JvbGxQb3NpdGlvbiA9IE1hdGgucm91bmQoX3BhZ2VTY3JvbGxJbnN0YW5jZS5wYWdlU2Nyb2xsT3B0aW9ucy5lYXNpbmdMb2dpYyhcbiAgICAgICAgICBjdXJyZW50VGltZSAtIF9wYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRUaW1lLFxuICAgICAgICAgIF9wYWdlU2Nyb2xsSW5zdGFuY2Uuc3RhcnRTY3JvbGxQb3NpdGlvbixcbiAgICAgICAgICBfcGFnZVNjcm9sbEluc3RhbmNlLmRpc3RhbmNlVG9TY3JvbGwsXG4gICAgICAgICAgX3BhZ2VTY3JvbGxJbnN0YW5jZS5leGVjdXRpb25EdXJhdGlvbikpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSA1ICYmIGlzRGV2TW9kZSgpKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignU2Nyb2xsIFBvc2l0aW9uOiAnICsgbmV3U2Nyb2xsUG9zaXRpb24pO1xuICAgICAgfVxuICAgICAgLy8gU2V0IHRoZSBuZXcgc2Nyb2xsUG9zaXRpb24gdG8gYWxsIHNjcm9sbFZpZXdzIGVsZW1lbnRzXG4gICAgICBpZiAoIV9wYWdlU2Nyb2xsSW5zdGFuY2Uuc2V0U2Nyb2xsUG9zaXRpb24obmV3U2Nyb2xsUG9zaXRpb24pKSB7XG4gICAgICAgIC8vIFNldHRpbmcgdGhlIG5ldyBzY3JvbGxUb3Avc2Nyb2xsTGVmdCB2YWx1ZSBmYWlsZWQgZm9yIGFsbCBTY3JvbGxWaWV3c1xuICAgICAgICAvLyBlYXJseSBzdG9wIHRoZSBzY3JvbGwgYW5pbWF0aW9uIHRvIHNhdmUgcmVzb3VyY2VzXG4gICAgICAgIHN0b3BOb3cgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBBdCB0aGUgZW5kIGRvIHRoZSBpbnRlcm5hbCBzdG9wIG1haW50ZW5hbmNlIGFuZCBmaXJlIHRoZSBwYWdlU2Nyb2xsRmluaXNoIGV2ZW50XG4gICAgICAvLyAob3RoZXJ3aXNlIHRoZSBldmVudCBtaWdodCBhcnJpdmUgYXQgXCJ0b28gZWFybHlcIilcbiAgICAgIGlmIChzdG9wTm93KSB7XG4gICAgICAgIHRoaXMuc3RvcEludGVybmFsKGZhbHNlLCBfcGFnZVNjcm9sbEluc3RhbmNlKTtcbiAgICAgIH1cblxuICAgIH0sIHRoaXMuY29uZmlnLl9pbnRlcnZhbCwgcGFnZVNjcm9sbEluc3RhbmNlKTtcblxuICAgIC8vIFJlZ2lzdGVyIHRoZSBpbnN0YW5jZSBhcyBydW5uaW5nIG9uZVxuICAgIHRoaXMucnVubmluZ0luc3RhbmNlcy5wdXNoKHBhZ2VTY3JvbGxJbnN0YW5jZSk7XG4gIH1cblxuICBwdWJsaWMgc2Nyb2xsKG9wdGlvbnM6IFBhZ2VTY3JvbGxPcHRpb25zKTogdm9pZCB7XG4gICAgdGhpcy5zdGFydCh0aGlzLmNyZWF0ZShvcHRpb25zKSk7XG4gIH1cblxuICAvKipcbiAgICogU3RvcCBhbGwgcnVubmluZyBzY3JvbGwgYW5pbWF0aW9ucy4gT3B0aW9uYWxseSBsaW1pdCB0byBzdG9wIG9ubHkgdGhlIG9uZXMgb2Ygc3BlY2lmaWMgbmFtZXNwYWNlLlxuICAgKi9cbiAgcHVibGljIHN0b3BBbGwobmFtZXNwYWNlPzogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMucnVubmluZ0luc3RhbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICBsZXQgc3RvcHBlZFNvbWUgPSBmYWxzZTtcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnJ1bm5pbmdJbnN0YW5jZXMubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgY29uc3QgcGFnZVNjcm9sbEluc3RhbmNlID0gdGhpcy5ydW5uaW5nSW5zdGFuY2VzW2ldO1xuICAgICAgICBpZiAoIW5hbWVzcGFjZSB8fCBwYWdlU2Nyb2xsSW5zdGFuY2UucGFnZVNjcm9sbE9wdGlvbnMubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpIHtcbiAgICAgICAgICBzdG9wcGVkU29tZSA9IHRydWU7XG4gICAgICAgICAgdGhpcy5zdG9wSW50ZXJuYWwodHJ1ZSwgcGFnZVNjcm9sbEluc3RhbmNlKTtcbiAgICAgICAgICAvLyBEZWNyZWFzZSB0aGUgY291bnRlciwgYXMgd2UgcmVtb3ZlZCBhbiBpdGVtIGZyb20gdGhlIGFycmF5IHdlIGl0ZXJhdGUgb3ZlclxuICAgICAgICAgIGktLTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gc3RvcHBlZFNvbWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN0b3AocGFnZVNjcm9sbEluc3RhbmNlOiBQYWdlU2Nyb2xsSW5zdGFuY2UpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zdG9wSW50ZXJuYWwodHJ1ZSwgcGFnZVNjcm9sbEluc3RhbmNlKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoTkdYUFNfQ09ORklHKSBjdXN0b21Db25maWc6IFBhZ2VTY3JvbGxDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsuLi5kZWZhdWx0UGFnZVNjcm9sbENvbmZpZywgLi4uY3VzdG9tQ29uZmlnfTtcblxuICAgIGlmIChQYWdlU2Nyb2xsU2VydmljZS5pbnN0YW5jZUNvdW50ZXIgPiAwICYmXG4gICAgICAodGhpcy5jb25maWcuX2xvZ0xldmVsID49IDIgfHwgKHRoaXMuY29uZmlnLl9sb2dMZXZlbCA+PSAxICYmIGlzRGV2TW9kZSgpKSkpIHtcbiAgICAgIGNvbnNvbGUud2FybignQW4gaW5zdGFuY2Ugb2YgUGFnZVNjcm9sbFNlcnZpY2UgYWxyZWFkeSBleGlzdHMsIHVzdWFsbHkgJyArXG4gICAgICAgICdpbmNsdWRpbmcgb25lIHByb3ZpZGVyIHNob3VsZCBiZSBlbm91Z2gsIHNvIGRvdWJsZSBjaGVjay4nKTtcbiAgICB9XG4gICAgUGFnZVNjcm9sbFNlcnZpY2UuaW5zdGFuY2VDb3VudGVyKys7XG4gIH1cbn1cbiJdfQ==